name: ğŸš€ Terraform Infrastructure Deployment
on:
    push:
        branches: [ main, develop ]
      
    pull_request:
        branches: [ main ]
        
    workflow_dispatch:  # Manual trigger
env:
  TF_VERSION: "1.12.2"
  AWS_REGION: ${{ secrets.AWS_REGION }}
  WORKING_DIR: "environments/dev"

jobs:
    # Job 1: Validation and Planning
    validate-and-plan:
        name: ğŸ” Validate & Plan
        runs-on: ubuntu-latest
        environment: dev

        steps:
            - name: ğŸ“¥ Checkout Code
              uses: actions/checkout@v4
            
            - name: ğŸ”§ Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: ${{ env.TF_VERSION }}

            - name: ğŸ” Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
               aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
               aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
               aws-region: ${{ secrets.AWS_REGION }}

            - name: ğŸ¨ Terraform Format Check
              working-directory: ${{ env.WORKING_DIR }}
              run: terraform fmt -check -recursive
            
            - name: âœ… Terraform Init
              working-directory: ${{ env.WORKING_DIR }}
              run: terraform init

            - name: ğŸ” Terraform Validate
              working-directory: ${{ env.WORKING_DIR }}
              run: terraform validate

            - name: ğŸ“‹ Terraform Plan
              working-directory: ${{ env.WORKING_DIR }}
              run: terraform plan -out=tfplan

            - name: ğŸ’¾ Save Plan Artifact
              
              uses: actions/upload-artifact@v4
              with:
                name: terraform-plan
                path: ${{ env.WORKING_DIR }}/tfplan
    approval:
        name: Deployment Approval
        runs-on: ubuntu-latest
        needs: validate-and-plan
        if: github.ref == 'refs/heads/main'  # Only for main branch
        environment: 
            name: dev
            url: https://console.aws.amazon.com
        steps:
            - name: ğŸ¯ Manual Approval Required
              run: |
                echo "Infrastructure plan is ready for deployment"
                echo "Review the plan in the previous job before approving"